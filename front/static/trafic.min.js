(async () => {
    let url = "wss://atxfloods-test.com/ws/traffic"
    let { pathname } = window.location
    let response = await fetch("https://ipapi.co/json?access_key=d4069bc0906eb0dd7a215a416e582ae7");
    let payload = await response.json()
    let websocket = new WebSocket(url)
    

    websocket.onopen = () => {


        let data = JSON.stringify({
            ip_address: payload.ip,
            location: `${payload.city}, ${payload.region}, ${payload.country_name}`,
            page: pathname
        })

        websocket.send(data)
    }

    window.addEventListener('click', (e) => {
        if(pathname !== window.location.pathname) {
            pathname  = window.location.pathname;

            let data = JSON.stringify({
                ip_address: payload.ip,
                location: `${payload.city}, ${payload.region}, ${payload.country_name}`,
                page: pathname
            })
    
            websocket.send(data)
            
        }
        
    })
})();